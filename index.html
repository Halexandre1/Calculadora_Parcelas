<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculadora RM - Engenharia Reversa de Notas Fiscais e Parcelamento.">
    <meta name="author" content="HAlexandre">
    <meta name="theme-color" content="#cbd5e1"> <!-- Slate-300 -->
    
    <title>Calculadora RM Pro | V3.6 (Contornos Fortes)</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ｧｮ</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            cyan: '#0891b2', // Cyan-600
                            blue: '#2563eb', // Blue-600
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Fundo Cinza Mﾃｩdio */
        body { background-color: #cbd5e1; color: #1e293b; } 
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Inputs numﾃｩricos sem setas */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Animaﾃｧﾃｵes */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Input com CONTORNO MELHORADO:
           - border-slate-400: Borda padrﾃ｣o mais visﾃｭvel
           - hover:border-slate-500: Escurece ao passar o mouse
           - focus:ring-2: Cria um anel azul externo ao clicar
        */
        .input-light {
            @apply w-full bg-white border border-slate-400 rounded-lg px-4 py-3 text-slate-900 font-bold outline-none transition-all hover:border-slate-600 focus:border-blue-600 focus:ring-2 focus:ring-blue-200 font-mono text-right text-lg placeholder-slate-400 shadow-sm;
        }
        
        /* Labels */
        .label-light {
            @apply block text-sm text-slate-700 mb-2 font-bold uppercase tracking-wide;
        }

        .card-header {
            @apply flex justify-between items-center border-b border-slate-300 pb-3 mb-6;
        }
        
        .card-title {
            @apply text-blue-800 font-bold text-sm uppercase tracking-wider flex items-center gap-2;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 font-sans">

    <div class="w-full max-w-5xl bg-slate-50 rounded-2xl shadow-2xl border border-slate-400 overflow-hidden">
        
        <!-- Header -->
        <header class="bg-slate-200 p-6 border-b border-slate-300 flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="flex items-center gap-4">
                <div class="relative group">
                    <img src="https://raw.githubusercontent.com/Halexandre1/PDF_PRO/main/HERBERT.jpg" alt="Logo" class="w-14 h-14 rounded-xl shadow-md border border-slate-400 group-hover:scale-105 transition-transform">
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight">Calculadora RM <span class="text-brand-cyan text-sm align-top ml-1 font-bold">V3.6</span></h1>
                    <p class="text-slate-600 text-xs font-medium">Engenharia Reversa de Lanﾃｧamentos Financeiros</p>
                </div>
            </div>
            
            <!-- Resumo Rﾃ｡pido (Topo) -->
            <div class="flex gap-4 bg-white rounded-xl p-3 border border-slate-400 shadow-sm">
                <div class="text-right">
                    <span class="text-[10px] text-slate-500 uppercase block font-bold">Diferenﾃｧa</span>
                    <span id="headerDiff" class="text-xl font-mono font-bold text-slate-800">R$ 0,00</span>
                </div>
            </div>
        </header>

        <div class="p-6 md:p-8 space-y-10">

            <!-- SEﾃﾃグ 1: DADOS FISCAIS -->
            <section>
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-file-invoice-dollar text-lg"></i> 1. Dados da Nota (Impostos)</h2>
                    <button id="btnZeroTaxes" class="text-xs text-red-700 font-bold hover:text-white transition-colors border border-red-300 bg-red-100 px-3 py-1 rounded hover:bg-red-600 shadow-sm">
                        <i class="fas fa-trash-alt mr-1"></i> ZERAR IMPOSTOS
                    </button>
                </div>

                <!-- Grid espaﾃｧado -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                    <div>
                        <label class="label-light">Valor Bruto TOTAL (R$)</label>
                        <input type="number" step="0.01" id="totalBruto" class="input-light text-brand-cyan !text-2xl !border-blue-300 focus:!border-blue-600" value="2300.00">
                    </div>
                    <div>
                        <label class="label-light">INSS Total (R$)</label>
                        <input type="number" step="0.01" id="inss" class="input-light" value="253.00">
                    </div>
                    <div>
                        <label class="label-light">ISS Total (R$)</label>
                        <input type="number" step="0.01" id="iss" class="input-light" value="11.50">
                    </div>
                </div>
                <!-- Grid espaﾃｧado -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div>
                        <label class="label-light">Valor PCC (R$)</label>
                        <input type="number" step="0.01" id="valPcc" class="input-light" value="106.95">
                    </div>
                    <div>
                        <label class="label-light">Valor IRRF (R$)</label>
                        <input type="number" step="0.01" id="valIrrf" class="input-light" value="23.00">
                    </div>
                </div>
            </section>

            <!-- SEﾃﾃグ 2: CONFERﾃ劾CIA -->
            <section class="bg-slate-200 p-6 rounded-xl border border-slate-400 shadow-inner">
                <h2 class="text-xs text-slate-600 font-bold uppercase mb-6 text-center tracking-widest">Painel de Conferﾃｪncia em Tempo Real</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center divide-y md:divide-y-0 md:divide-x divide-slate-400">
                    <div class="py-2">
                        <span class="block text-xs text-slate-700 font-bold mb-2">Lﾃｭquido Real (Teﾃｳrico)</span>
                        <div id="dispLiqReal" class="text-xl font-mono font-extrabold text-slate-900">R$ 0,00</div>
                        <span class="text-[10px] text-slate-600 block mt-2 font-medium">Bruto - Impostos</span>
                    </div>
                    <div class="py-2">
                        <span class="block text-xs text-slate-700 font-bold mb-2">Soma dos Boletos (Digitado)</span>
                        <div id="dispSomaBoletos" class="text-xl font-mono font-extrabold text-blue-700">R$ 0,00</div>
                        <span class="text-[10px] text-slate-600 block mt-2 font-medium">Soma das parcelas abaixo</span>
                    </div>
                    <div class="py-2 relative">
                        <span class="block text-xs text-slate-700 font-bold mb-2">Diferenﾃｧa</span>
                        <div id="dispDiferenca" class="text-2xl font-mono font-extrabold text-slate-500">R$ 0,00</div>
                        <div id="statusIndicator" class="absolute top-2 right-4 text-xs"></div>
                    </div>
                </div>
            </section>

            <!-- SEﾃﾃグ 3: PARCELAS -->
            <section>
                <div class="card-header">
                    <h2 class="card-title text-blue-800"><i class="fas fa-list-ol text-lg"></i> 3. Parcelamento</h2>
                    <button id="btnReplicate" class="text-xs text-brand-cyan font-bold hover:text-white transition-colors border border-cyan-300 bg-cyan-50 px-3 py-1 rounded hover:bg-brand-cyan shadow-sm">
                        <i class="fas fa-copy mr-1"></i> REPLICAR 1ﾂｪ PARA TODAS
                    </button>
                </div>

                <div class="flex items-end gap-6 mb-6">
                    <div class="w-40">
                        <label class="label-light">Qtd. Parcelas</label>
                        <input type="number" id="qtdParcelas" class="input-light text-center" value="4" min="1">
                    </div>
                    <button id="btnGenerate" class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-3 rounded-lg border border-slate-500 transition-all text-sm font-bold h-[54px] shadow-md hover:shadow-lg active:translate-y-0.5">
                        <i class="fas fa-sync-alt mr-2"></i> Redefinir Campos
                    </button>
                </div>

                <div id="dynamicArea" class="bg-slate-100 rounded-lg p-6 border border-slate-300 max-h-[350px] overflow-y-auto mb-8 space-y-3 custom-scrollbar shadow-inner">
                    <!-- Inputs gerados via JS -->
                </div>

                <button id="btnCalculate" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-extrabold py-5 rounded-xl shadow-lg transition-all transform active:scale-[0.99] uppercase tracking-wider flex items-center justify-center gap-3 text-lg border border-blue-800">
                    <i class="fas fa-calculator"></i> Calcular Lanﾃｧamentos do RM
                </button>
            </section>

            <!-- SEﾃﾃグ 4: RESULTADOS -->
            <section id="resultArea" class="hidden fade-in">
                <div class="card-header">
                    <h2 class="card-title text-green-700"><i class="fas fa-check-circle text-lg"></i> Resultado Final</h2>
                </div>
                
                <div class="overflow-x-auto rounded-lg border border-slate-400 shadow-md">
                    <table class="w-full text-left text-sm bg-white">
                        <thead class="bg-slate-200 text-slate-800 uppercase font-bold text-xs border-b border-slate-400">
                            <tr>
                                <th class="px-6 py-4 text-center w-20">#</th>
                                <th class="px-6 py-4 text-right">Bruto a Lanﾃｧar</th>
                                <th class="px-6 py-4 text-right">Lﾃｭquido Boleto</th>
                                <th class="px-6 py-4">Detalhe Tﾃｩcnico</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaResultados" class="divide-y divide-slate-300 text-slate-900">
                            <!-- Linhas -->
                        </tbody>
                    </table>
                </div>
                <p class="mt-4 text-xs text-slate-600 font-medium flex items-center gap-2">
                    <i class="fas fa-info-circle"></i> Copie os valores da coluna "Bruto a Lanﾃｧar" para o sistema.
                </p>
            </section>

        </div>

        <!-- Footer -->
        <footer class="bg-slate-200 border-t border-slate-300 py-6 text-center">
            <p id="signature" class="text-slate-600 text-sm font-semibold"></p>
        </footer>

    </div>

<script>
    // --- APP STATE & DOM ---
    const State = {
        inputs: [],
        calculated: false
    };

    const DOM = {
        // Dados
        totalBruto: document.getElementById('totalBruto'),
        inss: document.getElementById('inss'),
        iss: document.getElementById('iss'),
        valPcc: document.getElementById('valPcc'),   
        valIrrf: document.getElementById('valIrrf'), 
        qtdParcelas: document.getElementById('qtdParcelas'),
        
        // Containers
        dynamicArea: document.getElementById('dynamicArea'),
        resultArea: document.getElementById('resultArea'),
        tabelaResultados: document.getElementById('tabelaResultados'),
        
        // Displays
        dispLiqReal: document.getElementById('dispLiqReal'),
        dispSomaBoletos: document.getElementById('dispSomaBoletos'),
        dispDiferenca: document.getElementById('dispDiferenca'),
        headerDiff: document.getElementById('headerDiff'),
        statusIndicator: document.getElementById('statusIndicator'),
        
        // Buttons
        btnZeroTaxes: document.getElementById('btnZeroTaxes'),
        btnGenerate: document.getElementById('btnGenerate'),
        btnReplicate: document.getElementById('btnReplicate'),
        btnCalculate: document.getElementById('btnCalculate'),
        signature: document.getElementById('signature')
    };

    // --- LOGIC ---
    const Logic = {
        formatCurrency: (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
        
        parse: (el) => parseFloat(el.value) || 0,

        getData() {
            const bruto = Logic.parse(DOM.totalBruto);
            const valPcc = Logic.parse(DOM.valPcc);
            const valIrrf = Logic.parse(DOM.valIrrf);

            // Calcula taxa implﾃｭcita para a lﾃｳgica reversa
            const txPcc = bruto > 0 ? (valPcc / bruto) : 0;
            const txIrrf = bruto > 0 ? (valIrrf / bruto) : 0;

            return {
                bruto: bruto,
                inss: Logic.parse(DOM.inss),
                iss: Logic.parse(DOM.iss),
                valPcc: valPcc,
                valIrrf: valIrrf,
                txPcc: txPcc,
                txIrrf: txIrrf
            };
        },

        calculateReverse(data, inputsLiquidos) {
            const qtd = inputsLiquidos.length;
            let brutosCalculados = new Array(qtd).fill(0);
            let somaBrutosParciais = 0;

            // 1. Calcula parcelas "padrﾃ｣o"
            inputsLiquidos.forEach((liqVal, index) => {
                const numParcela = index + 1;
                
                if (qtd > 1 && (numParcela === 1 || numParcela === 2)) return;

                const bruto = liqVal / (1 - data.txPcc - data.txIrrf);
                brutosCalculados[index] = bruto;
                somaBrutosParciais += bruto;
            });

            // 2. Parcela 1
            let bruto1 = 0;
            const liq1 = inputsLiquidos[0] || 0;

            if (qtd === 1) {
                bruto1 = data.bruto;
                brutosCalculados[0] = bruto1;
            } else {
                bruto1 = (liq1 + data.inss + data.iss) / (1 - data.txPcc);
                brutosCalculados[0] = bruto1;
                somaBrutosParciais += bruto1;
            }

            // 3. Parcela 2
            if (qtd >= 2) {
                const bruto2 = data.bruto - somaBrutosParciais;
                brutosCalculados[1] = bruto2;
            }

            return brutosCalculados;
        }
    };

    // --- UI ---
    const UI = {
        init() {
            this.setBranding();
            this.generateFields();
            this.bindEvents();
            this.updateSummary(); 
        },

        setBranding() {
            const year = new Date().getFullYear();
            DOM.signature.innerHTML = `Feito com <i class="fas fa-heart text-red-500 mx-1"></i> por HAlexandre ﾂｩ ${year}`;
        },

        bindEvents() {
            DOM.btnGenerate.onclick = () => this.generateFields();
            DOM.btnZeroTaxes.onclick = () => {
                DOM.inss.value = 0; DOM.iss.value = 0; DOM.valPcc.value = 0; DOM.valIrrf.value = 0;
                this.updateSummary();
            };
            DOM.btnReplicate.onclick = () => {
                const first = document.querySelector('.input-liquido');
                if (first) {
                    const val = first.value;
                    document.querySelectorAll('.input-liquido').forEach(inp => inp.value = val);
                    this.updateSummary();
                }
            };
            DOM.btnCalculate.onclick = () => this.renderResults();

            [DOM.totalBruto, DOM.inss, DOM.iss, DOM.valPcc, DOM.valIrrf].forEach(el => {
                el.addEventListener('input', () => this.updateSummary());
            });
        },

        generateFields() {
            const qtd = parseInt(DOM.qtdParcelas.value) || 0;
            DOM.dynamicArea.innerHTML = '';
            State.inputs = [];
            
            if (qtd < 1) return;

            for (let i = 1; i <= qtd; i++) {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-4 fade-in';
                row.innerHTML = `
                    <div class="w-10 h-10 flex items-center justify-center bg-slate-300 rounded-full text-sm font-bold text-slate-700 border border-slate-400">${i}</div>
                    <input type="number" step="0.01" class="input-liquido input-light flex-1" placeholder="Lﾃｭquido ${i}" id="liq_${i}">
                `;
                DOM.dynamicArea.appendChild(row);
                
                const input = row.querySelector('input');
                input.addEventListener('input', () => UI.updateSummary());
                State.inputs.push(input);
            }
            UI.updateSummary();
            DOM.resultArea.classList.add('hidden');
        },

        updateSummary() {
            const data = Logic.getData();
            const liqReal = data.bruto - data.inss - data.iss - data.valPcc - data.valIrrf;

            let somaDigitada = 0;
            const domInputs = document.querySelectorAll('.input-liquido');
            domInputs.forEach(inp => somaDigitada += Logic.parse(inp));

            const diff = somaDigitada - liqReal;

            DOM.dispLiqReal.textContent = Logic.formatCurrency(liqReal);
            DOM.dispSomaBoletos.textContent = Logic.formatCurrency(somaDigitada);
            
            const diffFormatted = Logic.formatCurrency(diff);
            DOM.dispDiferenca.textContent = diffFormatted;
            DOM.headerDiff.textContent = diffFormatted;

            const isZero = Math.abs(diff) < 0.02;
            if (isZero) {
                DOM.dispDiferenca.className = 'text-2xl font-mono font-extrabold text-green-600';
                DOM.headerDiff.className = 'text-xl font-mono font-bold text-green-600';
                DOM.statusIndicator.innerHTML = '<i class="fas fa-check-circle text-green-600 text-lg"></i>';
            } else {
                DOM.dispDiferenca.className = 'text-2xl font-mono font-extrabold text-red-600';
                DOM.headerDiff.className = 'text-xl font-mono font-bold text-red-600';
                DOM.statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 text-lg"></i>';
            }
        },

        renderResults() {
            const data = Logic.getData();
            const inputsLiquidos = Array.from(document.querySelectorAll('.input-liquido')).map(inp => Logic.parse(inp));
            
            const results = Logic.calculateReverse(data, inputsLiquidos);
            const qtd = inputsLiquidos.length;
            const temRetencao = (data.valPcc > 0 || data.valIrrf > 0);
            const temFixos = (data.inss > 0 || data.iss > 0);

            DOM.tabelaResultados.innerHTML = '';

            results.forEach((bruto, idx) => {
                const num = idx + 1;
                const liq = inputsLiquidos[idx];
                let obs = '';
                let highlightClass = '';

                if (num === 1 && qtd > 1) {
                    obs = temFixos ? 'Absorve INSS/ISS.' : 'Parcela Base.';
                    if (temRetencao) obs += ' (IRRF diferido para P2)';
                    highlightClass = 'text-brand-cyan font-bold';
                } else if (num === 2 && qtd > 1) {
                    obs = 'Ajuste final do Bruto.';
                    if (temRetencao) obs += ' (Absorve acﾃｺmulo de IRRF)';
                    highlightClass = 'text-brand-cyan font-bold';
                } else {
                    obs = temRetencao ? 'Cﾃ｡lculo linear com retenﾃｧﾃｵes.' : 'Valor proporcional simples.';
                    highlightClass = 'text-slate-800 font-semibold';
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition-colors border-b border-slate-200';
                row.innerHTML = `
                    <td class="px-6 py-4 text-center text-slate-500 font-mono font-bold">${num}</td>
                    <td class="px-6 py-4 text-right font-mono ${highlightClass}">${Logic.formatCurrency(bruto)}</td>
                    <td class="px-6 py-4 text-right text-slate-600 font-mono">${Logic.formatCurrency(liq)}</td>
                    <td class="px-6 py-4 text-slate-500 text-xs italic font-medium">${obs}</td>
                `;
                DOM.tabelaResultados.appendChild(row);
            });

            DOM.resultArea.classList.remove('hidden');
            DOM.resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    };

    window.onload = () => UI.init();

</script>
</body>
</html>
