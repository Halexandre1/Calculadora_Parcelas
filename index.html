<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculadora RM - Engenharia Reversa de Notas Fiscais e Parcelamento.">
    <meta name="author" content="HAlexandre">
    <meta name="theme-color" content="#06b6d4"> <!-- Cyan-500 -->
    
    <title>Calculadora RM Pro | V3.3</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ｧｮ</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: {
                            900: '#121212',
                            800: '#1e1e1e',
                            700: '#2d2d2d',
                            600: '#333333',
                        },
                        brand: {
                            cyan: '#00e5ff',
                            blue: '#2979ff',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #121212; color: #e0e0e0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00e5ff; }

        /* Inputs numﾃｩricos sem setas */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Animaﾃｧﾃｵes */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-dark {
            @apply w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-3 text-white outline-none transition-all focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 font-mono text-right text-lg;
        }
        
        .label-dark {
            @apply block text-xs text-gray-400 mb-2 font-medium uppercase tracking-wide;
        }

        .card-header {
            @apply flex justify-between items-center border-b border-dark-600 pb-3 mb-6;
        }
        
        .card-title {
            @apply text-brand-blue font-bold text-sm uppercase tracking-wider flex items-center gap-2;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

    <div class="w-full max-w-5xl bg-dark-800 rounded-2xl shadow-[0_0_40px_rgba(0,0,0,0.5)] border border-dark-600 overflow-hidden">
        
        <!-- Header -->
        <header class="bg-dark-900/50 p-6 border-b border-dark-600 flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="flex items-center gap-4">
                <div class="relative group">
                    <img src="https://raw.githubusercontent.com/Halexandre1/PDF_PRO/main/HERBERT.jpg" alt="Logo" class="w-14 h-14 rounded-xl shadow-lg border border-dark-600 group-hover:scale-105 transition-transform">
                    <div class="absolute inset-0 rounded-xl ring-1 ring-white/10"></div>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white tracking-tight">Calculadora RM <span class="text-brand-cyan text-sm align-top ml-1">V3.3 Pro</span></h1>
                    <p class="text-gray-500 text-xs">Engenharia Reversa de Lanﾃｧamentos Financeiros</p>
                </div>
            </div>
            
            <!-- Resumo Rﾃ｡pido (Topo) -->
            <div class="flex gap-4 bg-dark-900 rounded-xl p-3 border border-dark-700">
                <div class="text-right">
                    <span class="text-[10px] text-gray-500 uppercase block">Diferenﾃｧa</span>
                    <span id="headerDiff" class="text-xl font-mono font-bold text-gray-400">R$ 0,00</span>
                </div>
            </div>
        </header>

        <div class="p-6 md:p-8 space-y-10"> <!-- Aumentado espaﾃｧamento vertical geral -->

            <!-- SEﾃﾃグ 1: DADOS FISCAIS -->
            <section>
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-file-invoice-dollar"></i> 1. Dados da Nota (Impostos)</h2>
                    <button id="btnZeroTaxes" class="text-xs text-red-400 hover:text-red-300 transition-colors border border-red-900/50 bg-red-900/10 px-3 py-1 rounded hover:bg-red-900/20">
                        <i class="fas fa-trash-alt mr-1"></i> ZERAR IMPOSTOS
                    </button>
                </div>

                <!-- Grid espaﾃｧado -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                    <div>
                        <label class="label-dark">Valor Bruto TOTAL (R$)</label>
                        <input type="number" step="0.01" id="totalBruto" class="input-dark text-brand-cyan font-bold !text-xl" value="2300.00">
                    </div>
                    <div>
                        <label class="label-dark">INSS Total (R$)</label>
                        <input type="number" step="0.01" id="inss" class="input-dark" value="253.00">
                    </div>
                    <div>
                        <label class="label-dark">ISS Total (R$)</label>
                        <input type="number" step="0.01" id="iss" class="input-dark" value="11.50">
                    </div>
                </div>
                <!-- Grid espaﾃｧado -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div>
                        <label class="label-dark">Valor PCC (R$)</label>
                        <input type="number" step="0.01" id="valPcc" class="input-dark border-cyan-900/30 focus:border-cyan-500" value="106.95">
                    </div>
                    <div>
                        <label class="label-dark">Valor IRRF (R$)</label>
                        <input type="number" step="0.01" id="valIrrf" class="input-dark border-cyan-900/30 focus:border-cyan-500" value="23.00">
                    </div>
                    <!-- Espaﾃｧo vazio para alinhar se necessﾃ｡rio -->
                </div>
            </section>

            <!-- SEﾃﾃグ 2: CONFERﾃ劾CIA -->
            <section class="bg-dark-700/30 p-6 rounded-xl border border-dark-600/50">
                <h2 class="text-xs text-gray-500 font-bold uppercase mb-6 text-center tracking-widest">Painel de Conferﾃｪncia em Tempo Real</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center divide-y md:divide-y-0 md:divide-x divide-dark-600">
                    <div class="py-2">
                        <span class="block text-xs text-gray-400 mb-2">Lﾃｭquido Real (Teﾃｳrico)</span>
                        <div id="dispLiqReal" class="text-xl font-mono font-bold text-white">R$ 0,00</div>
                        <span class="text-[10px] text-gray-600 block mt-2">Bruto - Impostos</span>
                    </div>
                    <div class="py-2">
                        <span class="block text-xs text-gray-400 mb-2">Soma dos Boletos (Digitado)</span>
                        <div id="dispSomaBoletos" class="text-xl font-mono font-bold text-brand-blue">R$ 0,00</div>
                        <span class="text-[10px] text-gray-600 block mt-2">Soma das parcelas abaixo</span>
                    </div>
                    <div class="py-2 relative">
                        <span class="block text-xs text-gray-400 mb-2">Diferenﾃｧa</span>
                        <div id="dispDiferenca" class="text-2xl font-mono font-bold text-gray-400">R$ 0,00</div>
                        <div id="statusIndicator" class="absolute top-2 right-4 text-xs"></div>
                    </div>
                </div>
            </section>

            <!-- SEﾃﾃグ 3: PARCELAS -->
            <section>
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-list-ol"></i> 3. Parcelamento</h2>
                    <button id="btnReplicate" class="text-xs text-brand-cyan hover:text-white transition-colors border border-cyan-900/50 bg-cyan-900/10 px-3 py-1 rounded hover:bg-cyan-900/20">
                        <i class="fas fa-copy mr-1"></i> REPLICAR 1ﾂｪ PARA TODAS
                    </button>
                </div>

                <div class="flex items-end gap-6 mb-6">
                    <div class="w-40">
                        <label class="label-dark">Qtd. Parcelas</label>
                        <input type="number" id="qtdParcelas" class="input-dark text-center" value="4" min="1">
                    </div>
                    <button id="btnGenerate" class="bg-dark-700 hover:bg-dark-600 text-white px-6 py-3 rounded-lg border border-dark-600 transition-all text-sm font-medium h-[54px]">
                        <i class="fas fa-sync-alt mr-2"></i> Redefinir Campos
                    </button>
                </div>

                <div id="dynamicArea" class="bg-dark-900 rounded-lg p-6 border border-dark-700 max-h-[350px] overflow-y-auto mb-8 space-y-3 custom-scrollbar">
                    <!-- Inputs gerados via JS -->
                </div>

                <button id="btnCalculate" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-5 rounded-xl shadow-[0_0_20px_rgba(6,182,212,0.2)] transition-all transform active:scale-[0.99] uppercase tracking-wider flex items-center justify-center gap-3 text-lg">
                    <i class="fas fa-calculator"></i> Calcular Lanﾃｧamentos do RM
                </button>
            </section>

            <!-- SEﾃﾃグ 4: RESULTADOS -->
            <section id="resultArea" class="hidden fade-in">
                <div class="card-header">
                    <h2 class="card-title text-green-400"><i class="fas fa-check-circle"></i> Resultado Final</h2>
                </div>
                
                <div class="overflow-x-auto rounded-lg border border-dark-600">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-dark-700 text-gray-400 uppercase font-medium text-xs">
                            <tr>
                                <th class="px-6 py-4 text-center w-20">#</th>
                                <th class="px-6 py-4 text-right">Bruto a Lanﾃｧar</th>
                                <th class="px-6 py-4 text-right">Lﾃｭquido Boleto</th>
                                <th class="px-6 py-4">Detalhe Tﾃｩcnico</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaResultados" class="divide-y divide-dark-700 bg-dark-800">
                            <!-- Linhas -->
                        </tbody>
                    </table>
                </div>
                <p class="mt-4 text-xs text-gray-500 flex items-center gap-2">
                    <i class="fas fa-info-circle"></i> Copie os valores da coluna "Bruto a Lanﾃｧar" para o sistema.
                </p>
            </section>

        </div>

        <!-- Footer -->
        <footer class="bg-dark-900 border-t border-dark-600 py-6 text-center">
            <p id="signature" class="text-gray-500 text-sm font-medium"></p>
        </footer>

    </div>

<script>
    // --- APP STATE & DOM ---
    const State = {
        inputs: [],
        calculated: false
    };

    const DOM = {
        // Dados
        totalBruto: document.getElementById('totalBruto'),
        inss: document.getElementById('inss'),
        iss: document.getElementById('iss'),
        valPcc: document.getElementById('valPcc'),   // Novo ID
        valIrrf: document.getElementById('valIrrf'), // Novo ID
        qtdParcelas: document.getElementById('qtdParcelas'),
        
        // Containers
        dynamicArea: document.getElementById('dynamicArea'),
        resultArea: document.getElementById('resultArea'),
        tabelaResultados: document.getElementById('tabelaResultados'),
        
        // Displays
        dispLiqReal: document.getElementById('dispLiqReal'),
        dispSomaBoletos: document.getElementById('dispSomaBoletos'),
        dispDiferenca: document.getElementById('dispDiferenca'),
        headerDiff: document.getElementById('headerDiff'),
        statusIndicator: document.getElementById('statusIndicator'),
        
        // Buttons
        btnZeroTaxes: document.getElementById('btnZeroTaxes'),
        btnGenerate: document.getElementById('btnGenerate'),
        btnReplicate: document.getElementById('btnReplicate'),
        btnCalculate: document.getElementById('btnCalculate'),
        signature: document.getElementById('signature')
    };

    // --- LOGIC ---
    const Logic = {
        formatCurrency: (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
        
        parse: (el) => parseFloat(el.value) || 0,

        getData() {
            const bruto = Logic.parse(DOM.totalBruto);
            const valPcc = Logic.parse(DOM.valPcc);
            const valIrrf = Logic.parse(DOM.valIrrf);

            // Calcula taxa implﾃｭcita para a lﾃｳgica reversa
            // Taxa = Valor / Bruto
            const txPcc = bruto > 0 ? (valPcc / bruto) : 0;
            const txIrrf = bruto > 0 ? (valIrrf / bruto) : 0;

            return {
                bruto: bruto,
                inss: Logic.parse(DOM.inss),
                iss: Logic.parse(DOM.iss),
                valPcc: valPcc,
                valIrrf: valIrrf,
                txPcc: txPcc,
                txIrrf: txIrrf
            };
        },

        calculateReverse(data, inputsLiquidos) {
            const qtd = inputsLiquidos.length;
            let brutosCalculados = new Array(qtd).fill(0);
            let somaBrutosParciais = 0;

            // 1. Calcula parcelas "padrﾃ｣o" (da 3ﾂｪ em diante ou ﾃｺnica)
            inputsLiquidos.forEach((liqVal, index) => {
                const numParcela = index + 1;
                
                // Pula P1 e P2 se houverem mﾃｺltiplas parcelas (lﾃｳgica especial)
                if (qtd > 1 && (numParcela === 1 || numParcela === 2)) return;

                // Parcela Padrﾃ｣o: Bruto = Liq / (1 - Taxas)
                const bruto = liqVal / (1 - data.txPcc - data.txIrrf);
                brutosCalculados[index] = bruto;
                somaBrutosParciais += bruto;
            });

            // 2. Parcela 1 (Carregadora de Impostos Fixos)
            let bruto1 = 0;
            const liq1 = inputsLiquidos[0] || 0;

            if (qtd === 1) {
                bruto1 = data.bruto;
                brutosCalculados[0] = bruto1;
            } else {
                // P1 absorve INSS e ISS. O IRRF ﾃｩ jogado para P2.
                // Bruto1 = (Liq1 + Fixos) / (1 - PCC)
                bruto1 = (liq1 + data.inss + data.iss) / (1 - data.txPcc);
                brutosCalculados[0] = bruto1;
                somaBrutosParciais += bruto1;
            }

            // 3. Parcela 2 (Ajustadora Final)
            if (qtd >= 2) {
                // O que sobra do Bruto Total vai para a P2 para fechar a conta exata
                const bruto2 = data.bruto - somaBrutosParciais;
                brutosCalculados[1] = bruto2;
            }

            return brutosCalculados;
        }
    };

    // --- UI ---
    const UI = {
        init() {
            this.setBranding();
            this.generateFields();
            this.bindEvents();
            this.updateSummary(); // Calc inicial
        },

        setBranding() {
            const year = new Date().getFullYear();
            DOM.signature.innerHTML = `Feito com <i class="fas fa-heart text-red-500 mx-1"></i> por HAlexandre ﾂｩ ${year}`;
        },

        bindEvents() {
            DOM.btnGenerate.onclick = () => this.generateFields();
            DOM.btnZeroTaxes.onclick = () => {
                DOM.inss.value = 0; DOM.iss.value = 0; DOM.valPcc.value = 0; DOM.valIrrf.value = 0;
                this.updateSummary();
            };
            DOM.btnReplicate.onclick = () => {
                const first = document.querySelector('.input-liquido');
                if (first) {
                    const val = first.value;
                    document.querySelectorAll('.input-liquido').forEach(inp => inp.value = val);
                    this.updateSummary();
                }
            };
            DOM.btnCalculate.onclick = () => this.renderResults();

            // Auto-update inputs principais
            [DOM.totalBruto, DOM.inss, DOM.iss, DOM.valPcc, DOM.valIrrf].forEach(el => {
                el.addEventListener('input', () => this.updateSummary());
            });
        },

        generateFields() {
            const qtd = parseInt(DOM.qtdParcelas.value) || 0;
            DOM.dynamicArea.innerHTML = '';
            State.inputs = [];
            
            if (qtd < 1) return;

            for (let i = 1; i <= qtd; i++) {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-4 fade-in'; // Gap aumentado aqui tambﾃｩm
                row.innerHTML = `
                    <div class="w-10 h-10 flex items-center justify-center bg-dark-700 rounded-full text-sm font-bold text-gray-500 border border-dark-600">${i}</div>
                    <input type="number" step="0.01" class="input-liquido flex-1 bg-dark-800 border border-dark-600 rounded-lg px-4 py-3 text-white text-right focus:border-brand-blue outline-none transition-colors text-lg" placeholder="Lﾃｭquido ${i}" id="liq_${i}">
                `;
                DOM.dynamicArea.appendChild(row);
                
                // Bind input dinﾃ｢mico
                const input = row.querySelector('input');
                input.addEventListener('input', () => UI.updateSummary());
                State.inputs.push(input);
            }
            UI.updateSummary();
            DOM.resultArea.classList.add('hidden');
        },

        updateSummary() {
            const data = Logic.getData();
            
            // 1. Lﾃｭquido Real Teﾃｳrico (Usando valores absolutos direto para evitar erro de arredondamento de taxa)
            const liqReal = data.bruto - data.inss - data.iss - data.valPcc - data.valIrrf;

            // 2. Soma Digitada
            let somaDigitada = 0;
            const domInputs = document.querySelectorAll('.input-liquido');
            domInputs.forEach(inp => somaDigitada += Logic.parse(inp));

            // 3. Diferenﾃｧa
            const diff = somaDigitada - liqReal;

            // Render
            DOM.dispLiqReal.textContent = Logic.formatCurrency(liqReal);
            DOM.dispSomaBoletos.textContent = Logic.formatCurrency(somaDigitada);
            
            const diffFormatted = Logic.formatCurrency(diff);
            DOM.dispDiferenca.textContent = diffFormatted;
            DOM.headerDiff.textContent = diffFormatted;

            // Status Visual
            const isZero = Math.abs(diff) < 0.02;
            if (isZero) {
                DOM.dispDiferenca.className = 'text-2xl font-mono font-bold text-green-500';
                DOM.headerDiff.className = 'text-xl font-mono font-bold text-green-500';
                DOM.statusIndicator.innerHTML = '<i class="fas fa-check-circle text-green-500 text-lg"></i>';
            } else {
                DOM.dispDiferenca.className = 'text-2xl font-mono font-bold text-red-500';
                DOM.headerDiff.className = 'text-xl font-mono font-bold text-red-500';
                DOM.statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500 text-lg"></i>';
            }
        },

        renderResults() {
            const data = Logic.getData();
            const inputsLiquidos = Array.from(document.querySelectorAll('.input-liquido')).map(inp => Logic.parse(inp));
            
            const results = Logic.calculateReverse(data, inputsLiquidos);
            const qtd = inputsLiquidos.length;
            const temRetencao = (data.valPcc > 0 || data.valIrrf > 0);
            const temFixos = (data.inss > 0 || data.iss > 0);

            DOM.tabelaResultados.innerHTML = '';

            results.forEach((bruto, idx) => {
                const num = idx + 1;
                const liq = inputsLiquidos[idx];
                let obs = '';
                let highlightClass = '';

                if (num === 1 && qtd > 1) {
                    obs = temFixos ? 'Absorve INSS/ISS.' : 'Parcela Base.';
                    if (temRetencao) obs += ' (IRRF diferido para P2)';
                    highlightClass = 'text-brand-cyan font-bold';
                } else if (num === 2 && qtd > 1) {
                    obs = 'Ajuste final do Bruto.';
                    if (temRetencao) obs += ' (Absorve acﾃｺmulo de IRRF)';
                    highlightClass = 'text-brand-cyan font-bold';
                } else {
                    obs = temRetencao ? 'Cﾃ｡lculo linear com retenﾃｧﾃｵes.' : 'Valor proporcional simples.';
                    highlightClass = 'text-white';
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-dark-700/50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 text-center text-gray-500 font-mono">${num}</td>
                    <td class="px-6 py-4 text-right font-mono ${highlightClass}">${Logic.formatCurrency(bruto)}</td>
                    <td class="px-6 py-4 text-right text-gray-400 font-mono">${Logic.formatCurrency(liq)}</td>
                    <td class="px-6 py-4 text-gray-500 text-xs italic">${obs}</td>
                `;
                DOM.tabelaResultados.appendChild(row);
            });

            DOM.resultArea.classList.remove('hidden');
            DOM.resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    };

    // Inicializaﾃｧﾃ｣o
    window.onload = () => UI.init();

</script>
</body>
</html>
